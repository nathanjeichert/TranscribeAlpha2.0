name: Desktop Build

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            rust-target: x86_64-pc-windows-msvc
            tauri-args: ''
            ffmpeg-url: https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip
            ffmpeg-extract: zip
          - platform: macos-latest
            rust-target: aarch64-apple-darwin
            tauri-args: '--target aarch64-apple-darwin'
            ffmpeg-url: https://evermeet.cx/ffmpeg/getrelease/ffmpeg/7z
            ffmpeg-extract: 7z

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target }}

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install pyinstaller
          pip install -r requirements.txt

      # ── Build Python sidecar ──────────────────────────────────────────
      - name: Build Python sidecar
        shell: bash
        env:
          TAURI_TRIPLE: ${{ matrix.rust-target }}
        run: |
          mkdir -p frontend-next/src-tauri/binaries
          pyinstaller backend/sidecar.spec \
            --distpath frontend-next/src-tauri/binaries \
            --workpath .pyinstaller-build \
            --noconfirm

          # Verify the sidecar was produced
          SIDECAR="frontend-next/src-tauri/binaries/transcribealpha-server-${{ matrix.rust-target }}"
          if [[ "${{ matrix.rust-target }}" == *"windows"* ]]; then
            SIDECAR="${SIDECAR}.exe"
          fi
          if [ ! -f "$SIDECAR" ]; then
            echo "ERROR: sidecar not found at $SIDECAR"
            ls -la frontend-next/src-tauri/binaries/
            exit 1
          fi
          echo "Sidecar built: $SIDECAR ($(du -h "$SIDECAR" | cut -f1))"

      # ── Download FFmpeg ───────────────────────────────────────────────
      - name: Download FFmpeg (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          curl -L -o /tmp/ffmpeg.zip "${{ matrix.ffmpeg-url }}"
          unzip -o /tmp/ffmpeg.zip -d /tmp/ffmpeg-extract
          FFMPEG_EXE=$(find /tmp/ffmpeg-extract -name "ffmpeg.exe" | head -1)
          cp "$FFMPEG_EXE" "frontend-next/src-tauri/binaries/ffmpeg-${{ matrix.rust-target }}.exe"
          echo "FFmpeg ready: $(du -h "frontend-next/src-tauri/binaries/ffmpeg-${{ matrix.rust-target }}.exe" | cut -f1)"

      - name: Download FFmpeg (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          curl -L -o /tmp/ffmpeg.7z "${{ matrix.ffmpeg-url }}"
          # macOS runners have 7z via homebrew p7zip
          if ! command -v 7z &> /dev/null; then
            brew install p7zip
          fi
          7z x /tmp/ffmpeg.7z -o/tmp/ffmpeg-extract -y
          cp /tmp/ffmpeg-extract/ffmpeg "frontend-next/src-tauri/binaries/ffmpeg-${{ matrix.rust-target }}"
          chmod +x "frontend-next/src-tauri/binaries/ffmpeg-${{ matrix.rust-target }}"
          echo "FFmpeg ready: $(du -h "frontend-next/src-tauri/binaries/ffmpeg-${{ matrix.rust-target }}" | cut -f1)"

      # ── Frontend + Tauri build ────────────────────────────────────────
      - name: Install frontend dependencies
        working-directory: frontend-next
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          # macOS signing (optional — builds work without these)
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          projectPath: frontend-next
          tauriScript: npx tauri
          args: ${{ matrix.tauri-args }}
          tagName: ${{ github.ref_name }}
          releaseName: 'TranscribeAlpha ${{ github.ref_name }}'
          releaseBody: 'Desktop release for TranscribeAlpha.'
          releaseDraft: true
          prerelease: false
