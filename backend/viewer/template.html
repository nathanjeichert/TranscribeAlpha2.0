<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Transcript Viewer</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    :root {
      /* Page dimensions matching DOCX */
      --page-width: 8.5in;
      --page-margin-left: 0.75in;
      --page-margin-right: 0.5in;
      --page-margin-top: 0.5in;
      --page-margin-bottom: 0.5in;
      --line-number-width: 0.4in;
      --font-size: 12pt;
      --line-height: 2.0;
      --lines-per-page: 25;

      /* Colors - Dark professional theme */
      --bg-app: #0d1117;
      --bg-video: #000000;
      --bg-document: #161b22;
      --bg-page: #ffffff;
      --bg-controls: rgba(13, 17, 23, 0.95);
      --text-primary: #1f2328;
      --text-secondary: #656d76;
      --text-muted: #8b949e;
      --text-light: #e6edf3;
      --accent: #2f81f7;
      --accent-hover: #58a6ff;
      --accent-highlight: rgba(47, 129, 247, 0.15);
      --border-subtle: rgba(48, 54, 61, 0.4);
      --border-muted: #30363d;
      --shadow-page: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    body {
      margin: 0;
      background: var(--bg-app);
      color: var(--text-light);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      overflow: hidden;
    }

    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 12px 20px;
      background: linear-gradient(180deg, rgba(13, 17, 23, 0.98) 0%, rgba(13, 17, 23, 0.9) 100%);
      border-bottom: 1px solid var(--border-muted);
      z-index: 100;
      transform: translateY(-100%);
      opacity: 0;
      transition: transform 0.25s ease, opacity 0.25s ease;
      backdrop-filter: blur(12px);
    }

    .app-header.visible {
      transform: translateY(0);
      opacity: 1;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .header-info h1 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-light);
      letter-spacing: -0.2px;
    }

    .header-info p {
      margin: 3px 0 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-meta {
      display: flex;
      gap: 16px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .header-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Main Layout */
    .app-main {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    /* Video Pane */
    .video-pane {
      flex: 0 0 48%;
      display: flex;
      flex-direction: column;
      background: var(--bg-video);
      min-width: 0;
    }

    .video-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }

    video {
      width: 100%;
      height: 100%;
      max-height: 100%;
      object-fit: contain;
      background: #000;
    }

    /* Controls */
    .controls {
      padding: 12px 16px;
      background: var(--bg-controls);
      border-top: 1px solid var(--border-muted);
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .control-btn {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--text-muted);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .control-btn:hover {
      color: var(--text-light);
      background: rgba(255, 255, 255, 0.08);
    }

    .control-btn:active {
      transform: scale(0.94);
    }

    .control-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .control-btn.play-btn {
      width: 44px;
      height: 44px;
      background: var(--accent);
      color: #fff;
      border-radius: 50%;
    }

    .control-btn.play-btn:hover {
      background: var(--accent-hover);
    }

    .control-btn.play-btn svg {
      width: 22px;
      height: 22px;
    }

    .progress-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .time-display {
      font-size: 11px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      color: var(--text-muted);
      min-width: 42px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .progress-track {
      flex: 1;
      height: 4px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .progress-track:hover {
      height: 6px;
    }

    .progress-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      width: 0%;
      pointer-events: none;
    }

    .progress-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      margin: 0;
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .volume-btn {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .volume-btn:hover {
      color: var(--text-light);
    }

    .volume-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .volume-slider {
      width: 70px;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 2px;
      outline: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-light);
      cursor: pointer;
    }

    .volume-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-light);
      border: none;
      cursor: pointer;
    }

    /* Document Pane */
    .document-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-document);
      min-width: 0;
      overflow: hidden;
    }

    .document-header {
      padding: 10px 20px;
      background: var(--bg-app);
      border-bottom: 1px solid var(--border-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-indicator {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
    }

    .page-nav {
      display: flex;
      gap: 6px;
    }

    .page-nav button {
      appearance: none;
      border: 1px solid var(--border-muted);
      background: transparent;
      color: var(--text-muted);
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .page-nav button:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--text-muted);
      color: var(--text-light);
    }

    .page-nav button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .page-nav button svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .document-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Document Page - Matches DOCX formatting */
    .doc-page {
      width: var(--page-width);
      max-width: 100%;
      background: var(--bg-page);
      box-shadow: var(--shadow-page);
      border-radius: 3px;
      margin-bottom: 24px;
      padding: var(--page-margin-top) var(--page-margin-right) var(--page-margin-bottom) var(--page-margin-left);
      display: none;
    }

    .doc-page.active {
      display: block;
    }

    .doc-lines {
      font-family: 'Courier New', Courier, monospace;
      font-size: var(--font-size);
      line-height: var(--line-height);
      color: var(--text-primary);
    }

    .doc-line {
      display: flex;
      cursor: pointer;
      transition: background 0.12s ease;
      margin: 0;
      padding: 0;
      border-radius: 2px;
    }

    .doc-line:hover {
      background: rgba(47, 129, 247, 0.06);
    }

    .doc-line.current {
      background: var(--accent-highlight);
    }

    .doc-line-number {
      width: var(--line-number-width);
      min-width: var(--line-number-width);
      text-align: right;
      padding-right: 12px;
      color: var(--text-secondary);
      font-weight: 400;
      user-select: none;
      font-variant-numeric: tabular-nums;
    }

    .doc-line.current .doc-line-number {
      color: var(--accent);
      font-weight: 500;
    }

    .doc-line-text {
      flex: 1;
      white-space: pre;
      overflow: visible;
    }

    .doc-empty {
      text-align: center;
      padding: 48px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .app-main {
        flex-direction: column;
      }

      .video-pane {
        flex: 0 0 40vh;
      }

      .document-pane {
        flex: 1;
      }

      .doc-page {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .header-meta {
        display: none;
      }

      .document-scroll {
        padding: 16px;
      }

      :root {
        --page-margin-left: 0.5in;
        --page-margin-right: 0.25in;
        --font-size: 10pt;
      }
    }

    /* Print styles */
    @media print {
      .video-pane,
      .controls,
      .app-header,
      .document-header {
        display: none !important;
      }

      .document-pane {
        overflow: visible;
      }

      .document-scroll {
        padding: 0;
        overflow: visible;
      }

      .doc-page {
        display: block !important;
        box-shadow: none;
        page-break-after: always;
        margin: 0;
      }

      .doc-line.current {
        background: none;
      }
    }

    /* Scrollbar styling */
    .document-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .document-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .document-scroll::-webkit-scrollbar-thumb {
      background: var(--border-muted);
      border-radius: 4px;
    }

    .document-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header" id="appHeader">
      <div class="header-content">
        <div class="header-info">
          <h1 id="caseTitle">Transcript Viewer</h1>
          <p id="caseDetails"></p>
        </div>
        <div class="header-meta">
          <span id="headerDate"></span>
          <span id="headerLocation"></span>
        </div>
      </div>
    </header>

    <main class="app-main">
      <div class="video-pane">
        <div class="video-container">
          <video id="mediaPlayer" preload="metadata" playsinline></video>
        </div>
        <div class="controls">
          <div class="controls-row">
            <button type="button" class="control-btn" id="rewindBtn" aria-label="Rewind 10 seconds">
              <svg viewBox="0 0 24 24"><path d="M12.5 3C17.15 3 21.08 6.03 22.47 10.22L20.1 11C19.05 7.81 16.04 5.5 12.5 5.5C10.54 5.5 8.77 6.22 7.38 7.38L10 10H3V3L5.6 5.6C7.45 4 9.85 3 12.5 3M10 12V22H8V14H6V12H10M18 14V20C18 21.11 17.11 22 16 22H14C12.9 22 12 21.1 12 20V14C12 12.9 12.9 12 14 12H16C17.11 12 18 12.9 18 14M14 14V20H16V14H14Z"/></svg>
            </button>
            <button type="button" class="control-btn play-btn" id="playBtn" aria-label="Play">
              <svg viewBox="0 0 24 24" id="playIcon"><polygon points="5,3 19,12 5,21"/></svg>
            </button>
            <button type="button" class="control-btn" id="forwardBtn" aria-label="Forward 10 seconds">
              <svg viewBox="0 0 24 24"><path d="M11.5 3C6.85 3 2.92 6.03 1.53 10.22L3.9 11C4.95 7.81 7.96 5.5 11.5 5.5C13.46 5.5 15.23 6.22 16.62 7.38L14 10H21V3L18.4 5.6C16.55 4 14.15 3 11.5 3M10 12V22H8V14H6V12H10M18 14V20C18 21.11 17.11 22 16 22H14C12.9 22 12 21.1 12 20V14C12 12.9 12.9 12 14 12H16C17.11 12 18 12.9 18 14M14 14V20H16V14H14Z"/></svg>
            </button>
            <div class="progress-container">
              <span class="time-display" id="currentTime">0:00</span>
              <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
                <input type="range" class="progress-input" id="progressBar" min="0" max="100" step="0.1" value="0" />
              </div>
              <span class="time-display" id="totalDuration">0:00</span>
            </div>
            <div class="volume-control">
              <button type="button" class="volume-btn" id="volumeBtn" aria-label="Toggle mute">
                <svg viewBox="0 0 24 24" id="volumeIcon"><path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/></svg>
              </button>
              <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="1" />
            </div>
          </div>
        </div>
      </div>

      <div class="document-pane">
        <div class="document-header">
          <span class="page-indicator" id="pageIndicator">Page 1 of 1</span>
          <div class="page-nav">
            <button type="button" id="prevPageBtn" disabled>
              <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
              Prev
            </button>
            <button type="button" id="nextPageBtn" disabled>
              Next
              <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </button>
          </div>
        </div>
        <div class="document-scroll" id="documentScroll">
          <div id="pagesContainer">
            <div class="doc-empty">Loading transcript...</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script id="transcript-data" type="application/json">__TRANSCRIPT_JSON__</script>
  <script>
    (function () {
      const dataElement = document.getElementById('transcript-data');
      let payload = {};
      try {
        payload = JSON.parse(dataElement.textContent || '{}');
      } catch (err) {
        console.error('Failed to parse transcript payload', err);
      }
      dataElement.remove();

      // Elements
      const video = document.getElementById('mediaPlayer');
      const playBtn = document.getElementById('playBtn');
      const playIcon = document.getElementById('playIcon');
      const rewindBtn = document.getElementById('rewindBtn');
      const forwardBtn = document.getElementById('forwardBtn');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const currentTimeEl = document.getElementById('currentTime');
      const totalDurationEl = document.getElementById('totalDuration');
      const volumeSlider = document.getElementById('volumeSlider');
      const volumeBtn = document.getElementById('volumeBtn');
      const volumeIcon = document.getElementById('volumeIcon');
      const pageIndicator = document.getElementById('pageIndicator');
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');
      const pagesContainer = document.getElementById('pagesContainer');
      const documentScroll = document.getElementById('documentScroll');
      const appHeader = document.getElementById('appHeader');
      const caseTitle = document.getElementById('caseTitle');
      const caseDetails = document.getElementById('caseDetails');
      const headerDate = document.getElementById('headerDate');
      const headerLocation = document.getElementById('headerLocation');

      // SVG icons
      const playIconSvg = '<polygon points="5,3 19,12 5,21"/>';
      const pauseIconSvg = '<path d="M6,4H10V20H6M14,4H18V20H14Z"/>';
      const volumeHighSvg = '<path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/>';
      const volumeMediumSvg = '<path d="M5,9V15H9L14,20V4L9,9M18.5,12C18.5,10.23 17.5,8.71 16,7.97V16C17.5,15.29 18.5,13.76 18.5,12Z"/>';
      const volumeMutedSvg = '<path d="M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.63,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.52C15.58,18.04 14.83,18.45 14,18.7V20.77C15.38,20.45 16.63,19.81 17.69,18.95L19.73,21L21,19.73L12,10.73M12,4L9.91,6.09L12,8.18Z"/>';

      // Data
      const allLines = Array.isArray(payload.lines) ? payload.lines : [];
      const titleData = (payload.meta && payload.meta.title) || {};
      const durationSeconds = Number(payload.meta && payload.meta.duration_seconds) || 0;
      const linesPerPage = Number(payload.meta && payload.meta.lines_per_page) || 25;
      const defaultFileName = (payload.media && (payload.media.relative_path || payload.media.filename)) || 'media.mp4';
      const mediaContentType = payload.media && payload.media.content_type;

      // Setup video source
      const source = document.createElement('source');
      source.src = defaultFileName;
      if (mediaContentType) {
        source.type = mediaContentType;
      }
      video.appendChild(source);

      // Setup header
      const displayCaseName = titleData.CASE_NAME || 'Transcript Viewer';
      const displayFileName = titleData.FILE_NAME || defaultFileName;
      const displayDate = titleData.DATE || '';
      const displayLocation = titleData.LOCATION || '';

      caseTitle.textContent = displayCaseName;
      document.title = displayCaseName + ' - Transcript';
      caseDetails.textContent = displayFileName;
      if (displayDate) headerDate.textContent = displayDate;
      if (displayLocation) headerLocation.textContent = displayLocation;

      // State
      let currentPageIndex = 0;
      let activeLineIndex = -1;
      const lineElements = new Map();
      const pageElements = [];
      let allPages = [];

      // Utilities
      function formatTime(seconds) {
        if (!Number.isFinite(seconds)) return '0:00';
        const totalSeconds = Math.max(0, Math.floor(seconds));
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        const s = totalSeconds % 60;
        if (h > 0) {
          return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        return `${m}:${String(s).padStart(2, '0')}`;
      }

      function updateVolumeIcon(volume) {
        if (volume === 0) {
          volumeIcon.innerHTML = volumeMutedSvg;
        } else if (volume < 0.5) {
          volumeIcon.innerHTML = volumeMediumSvg;
        } else {
          volumeIcon.innerHTML = volumeHighSvg;
        }
      }

      // Build pages from lines (25 lines per page)
      function buildPages() {
        allPages = [];
        if (!allLines.length) return;

        // Group lines by page_number or create pages of 25 lines
        const pageMap = new Map();

        allLines.forEach((line, idx) => {
          const pageNum = line.page_number || Math.floor(idx / linesPerPage) + 1;
          if (!pageMap.has(pageNum)) {
            pageMap.set(pageNum, []);
          }
          pageMap.get(pageNum).push(idx);
        });

        // Convert map to array of page objects
        const sortedPageNums = Array.from(pageMap.keys()).sort((a, b) => a - b);
        sortedPageNums.forEach(pageNum => {
          allPages.push({
            page_number: pageNum,
            line_indexes: pageMap.get(pageNum)
          });
        });
      }

      // Build document view
      function buildDocumentView() {
        buildPages();

        if (!allLines.length || !allPages.length) {
          pagesContainer.innerHTML = '<div class="doc-empty">No transcript available</div>';
          return;
        }

        pagesContainer.innerHTML = '';
        lineElements.clear();
        pageElements.length = 0;

        allPages.forEach((page, pageIdx) => {
          const pageEl = document.createElement('div');
          pageEl.className = 'doc-page';
          if (pageIdx === 0) pageEl.classList.add('active');

          const linesEl = document.createElement('div');
          linesEl.className = 'doc-lines';

          (page.line_indexes || []).forEach((lineIndex) => {
            const line = allLines[lineIndex];
            if (!line) return;

            const lineEl = document.createElement('div');
            lineEl.className = 'doc-line';
            lineEl.dataset.index = String(lineIndex);

            const numberEl = document.createElement('span');
            numberEl.className = 'doc-line-number';
            const displayNumber = line.line_number != null ? line.line_number : ((lineIndex % linesPerPage) + 1);
            numberEl.textContent = String(displayNumber);

            const textEl = document.createElement('span');
            textEl.className = 'doc-line-text';

            // Use rendered_text which already has proper formatting with speaker prefix and spacing
            const text = line.rendered_text || line.text || '';
            textEl.textContent = text;

            lineEl.appendChild(numberEl);
            lineEl.appendChild(textEl);
            linesEl.appendChild(lineEl);

            lineElements.set(lineIndex, lineEl);

            // Click to seek
            lineEl.addEventListener('click', () => {
              if (typeof line.start === 'number') {
                video.currentTime = Math.max(0, line.start - 0.05);
                if (video.paused) {
                  video.play().catch(() => {});
                }
              }
            });
          });

          pageEl.appendChild(linesEl);
          pagesContainer.appendChild(pageEl);
          pageElements.push(pageEl);
        });

        updatePageIndicator();
        updatePageButtons();
      }

      function showPage(index) {
        if (index < 0 || index >= pageElements.length) return;

        pageElements.forEach((el, i) => {
          el.classList.toggle('active', i === index);
        });
        currentPageIndex = index;
        updatePageIndicator();
        updatePageButtons();
        documentScroll.scrollTop = 0;
      }

      function updatePageIndicator() {
        const total = pageElements.length || 1;
        pageIndicator.textContent = `Page ${currentPageIndex + 1} of ${total}`;
      }

      function updatePageButtons() {
        prevPageBtn.disabled = currentPageIndex <= 0;
        nextPageBtn.disabled = currentPageIndex >= pageElements.length - 1;
      }

      // Find active line by current time
      function findActiveLine(time) {
        if (!allLines.length) return -1;

        for (let i = 0; i < allLines.length; i++) {
          const line = allLines[i];
          const start = Number(line.start) || 0;
          const end = Number(line.end);

          if (!Number.isFinite(end)) {
            if (time >= start && i === allLines.length - 1) return i;
            continue;
          }

          if (time < start) return Math.max(0, i - 1);
          if (time >= start && time < end) return i;
        }

        return allLines.length - 1;
      }

      function setActiveLine(lineIndex) {
        // Remove previous highlight
        lineElements.forEach(el => el.classList.remove('current'));

        if (lineIndex < 0 || lineIndex >= allLines.length) return;

        const lineEl = lineElements.get(lineIndex);
        if (lineEl) {
          lineEl.classList.add('current');

          // Find which page this line is on and show it
          for (let pageIdx = 0; pageIdx < allPages.length; pageIdx++) {
            const page = allPages[pageIdx];
            if (page.line_indexes && page.line_indexes.includes(lineIndex)) {
              if (pageIdx !== currentPageIndex) {
                showPage(pageIdx);
              }
              break;
            }
          }

          // Scroll line into view
          lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        activeLineIndex = lineIndex;
      }

      // Time update handler
      function handleTimeUpdate() {
        const currentTime = video.currentTime;
        const duration = video.duration || durationSeconds || 0;

        if (Number.isFinite(duration) && duration > 0) {
          const percent = (currentTime / duration) * 100;
          progressBar.value = String(percent);
          progressFill.style.width = percent + '%';
          totalDurationEl.textContent = formatTime(duration);
        }
        currentTimeEl.textContent = formatTime(currentTime);

        const lineIndex = findActiveLine(currentTime);
        if (lineIndex !== activeLineIndex) {
          setActiveLine(lineIndex);
        }
      }

      // Event listeners - Video controls
      playBtn.addEventListener('click', () => {
        if (video.paused) {
          video.play().catch(() => {});
        } else {
          video.pause();
        }
      });

      rewindBtn.addEventListener('click', () => {
        video.currentTime = Math.max(0, video.currentTime - 10);
      });

      forwardBtn.addEventListener('click', () => {
        const duration = video.duration || durationSeconds || 0;
        video.currentTime = Math.min(duration, video.currentTime + 10);
      });

      progressBar.addEventListener('input', (e) => {
        const duration = video.duration || durationSeconds || 0;
        if (duration) {
          const newTime = (Number(e.target.value) / 100) * duration;
          video.currentTime = newTime;
          progressFill.style.width = e.target.value + '%';
        }
      });

      volumeSlider.addEventListener('input', () => {
        video.volume = Number(volumeSlider.value);
        updateVolumeIcon(video.volume);
      });

      volumeBtn.addEventListener('click', () => {
        if (video.volume > 0) {
          volumeSlider.dataset.prevVolume = video.volume;
          video.volume = 0;
          volumeSlider.value = 0;
        } else {
          const prevVolume = Number(volumeSlider.dataset.prevVolume) || 1;
          video.volume = prevVolume;
          volumeSlider.value = prevVolume;
        }
        updateVolumeIcon(video.volume);
      });

      // Event listeners - Video state
      video.addEventListener('play', () => {
        playIcon.innerHTML = pauseIconSvg;
      });

      video.addEventListener('pause', () => {
        playIcon.innerHTML = playIconSvg;
      });

      video.addEventListener('timeupdate', handleTimeUpdate);
      video.addEventListener('seeked', handleTimeUpdate);
      video.addEventListener('loadedmetadata', () => {
        totalDurationEl.textContent = formatTime(video.duration || durationSeconds);
        handleTimeUpdate();
      });

      // Event listeners - Page navigation
      prevPageBtn.addEventListener('click', () => {
        if (currentPageIndex > 0) {
          showPage(currentPageIndex - 1);
        }
      });

      nextPageBtn.addEventListener('click', () => {
        if (currentPageIndex < pageElements.length - 1) {
          showPage(currentPageIndex + 1);
        }
      });

      // Header visibility on hover
      let headerTimeout = null;
      document.addEventListener('mousemove', (e) => {
        if (e.clientY <= 60) {
          appHeader.classList.add('visible');
          if (headerTimeout) clearTimeout(headerTimeout);
        } else if (appHeader.classList.contains('visible')) {
          if (headerTimeout) clearTimeout(headerTimeout);
          headerTimeout = setTimeout(() => {
            appHeader.classList.remove('visible');
          }, 800);
        }
      });

      appHeader.addEventListener('mouseenter', () => {
        if (headerTimeout) clearTimeout(headerTimeout);
        appHeader.classList.add('visible');
      });

      appHeader.addEventListener('mouseleave', () => {
        headerTimeout = setTimeout(() => {
          appHeader.classList.remove('visible');
        }, 400);
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;

        switch (e.key) {
          case ' ':
            e.preventDefault();
            if (video.paused) {
              video.play().catch(() => {});
            } else {
              video.pause();
            }
            break;
          case 'ArrowLeft':
            video.currentTime = Math.max(0, video.currentTime - 10);
            break;
          case 'ArrowRight':
            video.currentTime = Math.min(video.duration || 0, video.currentTime + 10);
            break;
          case 'ArrowUp':
            e.preventDefault();
            if (currentPageIndex > 0) showPage(currentPageIndex - 1);
            break;
          case 'ArrowDown':
            e.preventDefault();
            if (currentPageIndex < pageElements.length - 1) showPage(currentPageIndex + 1);
            break;
        }
      });

      // Initialize
      buildDocumentView();
      updateVolumeIcon(1);
    })();
  </script>
</body>
</html>
