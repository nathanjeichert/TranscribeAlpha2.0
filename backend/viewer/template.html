<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Transcript Viewer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root {
      --page-width: 8.5in;
      --page-margin-left: 1in;
      --page-margin-right: 1in;
      --page-margin-top: 0.75in;
      --page-margin-bottom: 0.75in;
      --line-number-width: 0.7in;
      --font-size: 12pt;
      --line-height: 2.0;
      --lines-per-page: 25;
      --sidebar-width: 320px;

      /* App color palette - slate tones */
      --color-50: #f8fafc;
      --color-100: #f1f5f9;
      --color-200: #e2e8f0;
      --color-300: #cbd5e1;
      --color-400: #94a3b8;
      --color-500: #64748b;
      --color-600: #475569;
      --color-700: #334155;
      --color-800: #1e293b;
      --color-900: #0f172a;

      --bg-app: var(--color-100);
      --bg-sidebar: #ffffff;
      --bg-card: #ffffff;
      --bg-page: #ffffff;
      --text-primary: var(--color-900);
      --text-secondary: var(--color-600);
      --text-muted: var(--color-400);
      --accent: var(--color-700);
      --accent-light: var(--color-600);
      --border: var(--color-200);
      --border-light: var(--color-100);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
      --amber-100: #fef3c7;
      --amber-300: #fcd34d;
      --amber-500: #f59e0b;
    }

    body {
      margin: 0;
      background: var(--bg-app);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      overflow: hidden;
    }

    .app { height: 100vh; display: flex; }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
      z-index: 50;
    }

    .sidebar.collapsed { display: none; }

    .sidebar-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--accent);
    }

    .sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-close {
      appearance: none;
      border: none;
      background: rgba(255,255,255,0.15);
      color: #ffffff;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }
    .sidebar-close:hover { background: rgba(255,255,255,0.25); }
    .sidebar-close svg { width: 16px; height: 16px; fill: currentColor; }

    .sidebar-content { flex: 1; overflow-y: auto; padding: 16px; }

    /* Search */
    .search-box {
      position: relative;
      margin-bottom: 16px;
    }
    .search-input {
      width: 100%;
      padding: 10px 12px;
      padding-right: 90px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      background: var(--color-50);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(51,65,85,0.1); }
    .search-input::placeholder { color: var(--text-muted); }
    .search-controls {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
      align-items: center;
      gap: 2px;
    }
    .search-controls.visible { display: flex; }
    .search-count { font-size: 11px; color: var(--text-muted); margin-right: 4px; }
    .search-btn {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--text-muted);
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.15s, background 0.15s;
    }
    .search-btn:hover { color: var(--text-primary); background: var(--color-100); }
    .search-btn svg { width: 14px; height: 14px; fill: currentColor; }

    /* Sidebar Sections */
    .sidebar-section { margin-bottom: 20px; }
    .sidebar-section:last-child { margin-bottom: 0; }
    .section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    /* Clip Creator */
    .clip-creator {
      background: var(--color-50);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 16px;
    }
    .clip-creator-title { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
    .clip-row { display: flex; gap: 8px; margin-bottom: 10px; }
    .clip-input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      background: #ffffff;
      color: var(--text-primary);
      outline: none;
    }
    .clip-input:focus { border-color: var(--accent); }
    .clip-input::placeholder { color: var(--text-muted); }
    .clip-time { width: 70px; text-align: center; font-family: 'SF Mono', 'Monaco', monospace; font-size: 11px; }
    .clip-actions { display: flex; gap: 6px; }

    /* Buttons */
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }
    .btn:hover { border-color: var(--color-300); background: var(--color-50); color: var(--text-primary); }
    .btn svg { width: 14px; height: 14px; fill: currentColor; }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
    }
    .btn-primary:hover { background: var(--accent-light); border-color: var(--accent-light); color: #ffffff; }
    .btn-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .btn-row .btn { flex: 1; justify-content: center; }

    /* Clips List */
    .clips-list { max-height: 200px; overflow-y: auto; }
    .clip-item {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.15s;
      background: #ffffff;
    }
    .clip-item:hover { border-color: var(--color-300); background: var(--color-50); }
    .clip-item.active { border-color: var(--accent); background: rgba(51,65,85,0.05); }
    .clip-item-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .clip-item-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
    .clip-item-time { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .clip-item-delete {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--text-muted);
      width: 22px;
      height: 22px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .clip-item-delete:hover { color: #dc2626; background: #fef2f2; }
    .clip-item-delete svg { width: 14px; height: 14px; fill: currentColor; }
    .no-clips { font-size: 12px; color: var(--text-muted); text-align: center; padding: 16px; }

    /* Media */
    .media-meta {
      background: var(--color-50);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
    }
    .media-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .media-hint {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    /* Settings */
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .setting-toggle {
      width: 40px;
      height: 22px;
      background: var(--color-200);
      border-radius: 11px;
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
    }
    .setting-toggle.active { background: var(--accent); }
    .setting-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 16px;
      height: 16px;
      background: #ffffff;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: var(--shadow-sm);
    }
    .setting-toggle.active::after { transform: translateX(18px); }

    /* View Toggle */
    .view-toggle {
      display: flex;
      background: var(--color-100);
      border-radius: 6px;
      padding: 2px;
    }
    .view-btn {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--text-muted);
      padding: 5px 12px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .view-btn.active { background: #ffffff; color: var(--text-primary); box-shadow: var(--shadow-sm); }

    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; }

    .main-header {
      padding: 12px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text-secondary);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .menu-btn:hover { border-color: var(--color-300); color: var(--text-primary); }
    .menu-btn svg { width: 18px; height: 18px; fill: currentColor; }

    .header-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Content Area */
    .content-area {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Video Pane */
    .video-pane {
      flex: 0 0 50%;
      display: flex;
      flex-direction: column;
      background: var(--color-900);
    }

    .video-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000000;
    }

    .video-container video {
      max-width: 100%;
      max-height: 100%;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Caption Overlay */
    .caption-overlay {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      background: rgba(0,0,0,0.85);
      padding: 40px 60px;
      pointer-events: none;
      overflow: hidden;
    }
    .video-pane.caption-mode .caption-overlay { display: flex; }
    .caption-line {
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      color: rgba(255,255,255,0.4);
      padding: 4px 12px;
      white-space: pre-wrap;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    .caption-line.current {
      color: #ffffff;
      font-weight: 500;
      background: rgba(255,255,255,0.1);
      border-left-color: var(--amber-500);
      font-size: 16px;
      padding: 8px 12px;
    }
    .caption-line.prev-1 { color: rgba(255,255,255,0.6); }
    .caption-line.prev-2 { color: rgba(255,255,255,0.35); }
    .caption-line.next-1 { color: rgba(255,255,255,0.6); }
    .caption-line.next-2 { color: rgba(255,255,255,0.35); }

    /* Title Card */
    .title-card {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      opacity: 0;
      transition: opacity 0.5s;
    }
    .title-card.visible { display: flex; opacity: 1; }
    .title-card-name { font-size: 28px; font-weight: 600; color: #ffffff; margin-bottom: 8px; }
    .title-card-meta { font-size: 16px; color: rgba(255,255,255,0.7); }

    /* Video Controls */
    .controls {
      background: var(--color-800);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .ctrl-btn {
      appearance: none;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.8);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .ctrl-btn:hover { background: rgba(255,255,255,0.1); color: #ffffff; }
    .ctrl-btn svg { width: 20px; height: 20px; fill: currentColor; }
    .ctrl-btn.play-btn { width: 42px; height: 42px; }
    .ctrl-btn.play-btn svg { width: 24px; height: 24px; }

    .progress-area { flex: 1; display: flex; align-items: center; gap: 10px; }
    .time-label { font-size: 12px; color: rgba(255,255,255,0.7); font-variant-numeric: tabular-nums; min-width: 50px; }
    .time-label:last-child { text-align: right; }

    .progress-track {
      flex: 1;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      position: relative;
      cursor: pointer;
    }
    .progress-fill {
      height: 100%;
      background: #ffffff;
      border-radius: 3px;
      width: 0;
      pointer-events: none;
    }
    .progress-input {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      margin: 0;
    }

    .volume-area { display: flex; align-items: center; gap: 6px; }
    .volume-slider {
      width: 70px;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      cursor: pointer;
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: #ffffff;
      border-radius: 50%;
      cursor: pointer;
    }

    /* Document Pane */
    .document-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--color-100);
      border-left: 1px solid var(--border);
    }

    .doc-header {
      padding: 12px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .page-info { font-size: 13px; color: var(--text-secondary); }

    .page-nav { display: flex; gap: 6px; }
    .page-btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text-secondary);
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .page-btn:hover:not(:disabled) { border-color: var(--color-300); color: var(--text-primary); }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .page-btn svg { width: 16px; height: 16px; fill: currentColor; }

    .doc-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .doc-page {
      width: var(--page-width);
      max-width: 100%;
      background: var(--bg-page);
      box-shadow: 0 4px 24px rgba(15,23,42,0.12);
      padding: 0.33in;
      position: relative;
      display: none;
    }
    .doc-page.active { display: block; }
    .doc-page::before,
    .doc-page::after {
      content: '';
      position: absolute;
      pointer-events: none;
      border: 1px solid var(--color-400);
    }
    .doc-page::before {
      top: 0.33in; right: 0.33in; bottom: 0.33in; left: 0.33in;
    }
    .doc-page::after {
      top: calc(0.33in + 4px); right: calc(0.33in + 4px); bottom: calc(0.33in + 4px); left: calc(0.33in + 4px);
    }
    .doc-page-inner {
      position: relative;
      padding: calc(var(--page-margin-top) - 0.33in) calc(var(--page-margin-right) - 0.33in) calc(var(--page-margin-bottom) - 0.33in) calc(var(--page-margin-left) - 0.33in);
    }
    .doc-page-number {
      text-align: center;
      font-family: 'Courier New', Courier, monospace;
      font-size: 10px;
      color: var(--text-muted);
      padding-top: 8px;
      user-select: none;
    }

    .doc-line {
      display: flex;
      font-family: 'Courier New', Courier, monospace;
      font-size: var(--font-size);
      line-height: var(--line-height);
      cursor: pointer;
      border-radius: 2px;
      margin: 0 calc(-1 * var(--line-number-width) - 8px) 0 -8px;
      padding: 0 8px 0 calc(var(--line-number-width) + 8px);
      transition: background 0.1s;
    }
    .doc-line:hover { background: var(--color-100); }
    .doc-line.active { background: var(--amber-100); }
    .doc-line.search-match { background: var(--amber-100); }
    .doc-line.search-current { background: var(--amber-300); }

    .line-num {
      width: var(--line-number-width);
      margin-left: calc(-1 * var(--line-number-width));
      flex-shrink: 0;
      color: var(--text-muted);
      font-size: 10px;
      text-align: right;
      padding-right: 12px;
      user-select: none;
    }

    .line-text {
      flex: 1;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--text-primary);
    }
    .line-text .speaker-name { font-weight: bold; }

    .doc-empty {
      text-align: center;
      padding: 48px;
      color: var(--text-muted);
    }

    /* Audio Waveform Visualizer */
    .waveform-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Caption Mode - hide document pane, video takes full width */
    .content-area.caption-mode .document-pane { display: none; }
    .content-area.caption-mode .video-pane { flex: 1; }

    /* Fullscreen - hide sidebar/header but keep transcript view */
    .app.fullscreen .sidebar,
    .app.fullscreen .main-header { display: none !important; }
    .app.fullscreen .video-pane { flex: 0 0 50%; }
    .app.fullscreen .document-pane { flex: 1; }
    .app.fullscreen .controls { background: transparent; position: absolute; bottom: 0; left: 0; right: 0; opacity: 0; transition: opacity 0.3s; z-index: 10; }
    .app.fullscreen:hover .controls { opacity: 1; }
    /* Fullscreen + caption mode - video full with captions */
    .app.fullscreen .content-area.caption-mode .video-pane { flex: 1; }
    .app.fullscreen .content-area.caption-mode .document-pane { display: none; }

    /* Responsive */
    @media (max-width: 1024px) {
      .content-area { flex-direction: column; }
      .video-pane { flex: 0 0 45vh; }
      .document-pane { flex: 1; border-left: none; border-top: 1px solid var(--border); }
      .sidebar { position: fixed; left: 0; top: 0; bottom: 0; box-shadow: var(--shadow-lg); }
    }

    /* Hidden */
    .hidden { display: none !important; }

    /* Print */
    @media print {
      .video-pane, .controls, .sidebar, .main-header, .doc-header { display: none !important; }
      .document-pane { border: none; }
      .doc-scroll { padding: 0; }
      .doc-page { box-shadow: none; border: none; display: block !important; page-break-after: always; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar collapsed" id="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
          Transcript Tools
        </span>
        <button type="button" class="sidebar-close" id="sidebarClose" aria-label="Close sidebar">
          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
      <div class="sidebar-content">
        <div class="search-box">
          <input type="text" class="search-input" id="searchInput" placeholder="Search transcript...">
          <div class="search-controls" id="searchControls">
            <span class="search-count" id="searchCount">0/0</span>
            <button type="button" class="search-btn" id="searchPrev" title="Previous"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button>
            <button type="button" class="search-btn" id="searchNext" title="Next"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg></button>
            <button type="button" class="search-btn" id="searchClear" title="Clear"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
          </div>
        </div>

        <div class="clip-creator">
          <div class="clip-creator-title">Create Clip</div>
          <div class="clip-row">
            <input type="text" class="clip-input" id="clipName" placeholder="Clip name">
          </div>
          <div class="clip-row">
            <input type="text" class="clip-input clip-time" id="clipStart" placeholder="0:00">
            <span style="color: var(--text-muted); font-size: 12px;">to</span>
            <input type="text" class="clip-input clip-time" id="clipEnd" placeholder="0:00">
          </div>
          <div class="clip-actions">
            <button type="button" class="btn" id="setStart">Set Start</button>
            <button type="button" class="btn" id="setEnd">Set End</button>
            <button type="button" class="btn btn-primary" id="addClip">Add</button>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="section-title">Clips</div>
          <div class="btn-row">
            <button type="button" class="btn" id="importClips"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zm0-10h4v6h6v-6h4l-7-7-7 7z"/></svg>Import</button>
            <button type="button" class="btn" id="exportClips"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Export</button>
          </div>
          <div class="clips-list" id="clipsList">
            <div class="no-clips">No clips yet</div>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="section-title">Media</div>
          <div class="btn-row">
            <button type="button" class="btn" id="loadMediaBtn">
              <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              Load Media
            </button>
          </div>
          <div class="media-meta">
            <div class="media-name" id="mediaName">No media file selected</div>
            <div class="media-hint">Attach a local audio/video file for playback. This does not import transcripts.</div>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="section-title">Transcript Sources</div>
          <div class="btn-row">
            <button type="button" class="btn" id="importSource"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Add Source</button>
          </div>
          <div id="sourcesList"></div>
        </div>

        <div class="sidebar-section">
          <div class="section-title">Settings</div>
          <div class="setting-row">
            <span>View mode</span>
            <div class="view-toggle">
              <button type="button" class="view-btn active" data-view="document">Doc</button>
              <button type="button" class="view-btn" data-view="caption">Caption</button>
            </div>
          </div>
          <div class="setting-row">
            <span>Title cards</span>
            <div class="setting-toggle" id="titleCardToggle"></div>
          </div>
        </div>
      </div>
    </aside>

    <div class="main-content">
      <div class="main-header">
        <button type="button" class="menu-btn" id="menuBtn" aria-label="Open menu">
          <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <div class="header-title" id="headerTitle">Transcript Viewer</div>
        <button type="button" class="menu-btn" id="fullscreenBtn" aria-label="Fullscreen">
          <svg viewBox="0 0 24 24" id="fsIcon"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
        </button>
      </div>

      <div class="content-area" id="contentArea">
        <div class="video-pane" id="videoPane">
          <div class="video-container">
            <video id="video" preload="metadata" playsinline></video>
            <canvas id="waveformCanvas" class="waveform-canvas" style="display:none;"></canvas>
            <div class="caption-overlay" id="captionOverlay">
              <div class="caption-line prev-2" id="captionPrev2"></div>
              <div class="caption-line prev-1" id="captionPrev1"></div>
              <div class="caption-line current" id="captionCurrent"></div>
              <div class="caption-line next-1" id="captionNext1"></div>
              <div class="caption-line next-2" id="captionNext2"></div>
            </div>
            <div class="title-card" id="titleCard">
              <div class="title-card-name" id="titleCardName"></div>
              <div class="title-card-meta" id="titleCardMeta"></div>
            </div>
          </div>
          <div class="controls">
            <button type="button" class="ctrl-btn" id="rewindBtn"><svg viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
            <button type="button" class="ctrl-btn play-btn" id="playBtn"><svg viewBox="0 0 24 24" id="playIcon"><polygon points="5,3 19,12 5,21"/></svg></button>
            <button type="button" class="ctrl-btn" id="forwardBtn"><svg viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></button>
            <div class="progress-area">
              <span class="time-label" id="currentTime">0:00</span>
              <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
                <input type="range" class="progress-input" id="progressBar" min="0" max="100" step="0.1" value="0">
              </div>
              <span class="time-label" id="duration">0:00</span>
            </div>
            <div class="volume-area">
              <button type="button" class="ctrl-btn" id="muteBtn"><svg viewBox="0 0 24 24" id="volIcon"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3A4.5 4.5 0 0014 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></button>
              <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="1">
            </div>
          </div>
        </div>

        <div class="document-pane" id="documentPane">
          <div class="doc-header">
            <span class="page-info" id="pageInfo">Page 1 of 1</span>
            <div class="page-nav">
              <button type="button" class="page-btn" id="prevPage" disabled><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
              <button type="button" class="page-btn" id="nextPage" disabled><svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
            </div>
          </div>
          <div class="doc-scroll" id="docScroll">
            <div id="pages"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" class="hidden" id="importSourceFile" accept=".html,.htm">
  <input type="file" class="hidden" id="importClipsFile" accept=".json">
  <input type="file" class="hidden" id="loadMediaFile" accept="audio/*,video/*">

  <script id="transcript-data" type="application/json">__TRANSCRIPT_JSON__</script>
  <script id="media-data" type="application/octet-stream"></script>
  <script>
(function() {
  'use strict';

  // Parse payload
  const dataEl = document.getElementById('transcript-data');
  const mediaDataEl = document.getElementById('media-data');
  let payload = {};
  try {
    const raw = dataEl ? dataEl.textContent : '{}';
    // Check if it starts with { (valid JSON) rather than __ (placeholder)
    if (raw && raw.charAt(0) === '{') payload = JSON.parse(raw);
  } catch(e) { console.error('JSON parse error:', e); }
  if (dataEl) dataEl.remove();

  // Data
  const allLines = Array.isArray(payload.lines) ? payload.lines : [];
  const meta = payload.meta || {};
  const titleData = meta.title || {};
  const mediaMeta = payload.media || {};
  const durationSec = Number(meta.duration_seconds) || 0;
  const linesPerPage = Number(meta.lines_per_page) || 25;
  const mediaPath = mediaMeta.relative_path || mediaMeta.filename || '';

  // Elements
  const $ = id => document.getElementById(id);
  const app = $('app');
  const sidebar = $('sidebar');
  const menuBtn = $('menuBtn');
  const sidebarClose = $('sidebarClose');
  const video = $('video');
  const playBtn = $('playBtn');
  const playIcon = $('playIcon');
  const rewindBtn = $('rewindBtn');
  const forwardBtn = $('forwardBtn');
  const progressBar = $('progressBar');
  const progressFill = $('progressFill');
  const currentTimeEl = $('currentTime');
  const durationEl = $('duration');
  const muteBtn = $('muteBtn');
  const volIcon = $('volIcon');
  const volumeSlider = $('volumeSlider');
  const fullscreenBtn = $('fullscreenBtn');
  const fsIcon = $('fsIcon');
  const videoPane = $('videoPane');
  const contentArea = $('contentArea');
  const pageInfo = $('pageInfo');
  const prevPage = $('prevPage');
  const nextPage = $('nextPage');
  const pages = $('pages');
  const docScroll = $('docScroll');
  const headerTitle = $('headerTitle');
  const captionPrev2 = $('captionPrev2');
  const captionPrev1 = $('captionPrev1');
  const captionCurrent = $('captionCurrent');
  const captionNext1 = $('captionNext1');
  const captionNext2 = $('captionNext2');
  const titleCard = $('titleCard');
  const titleCardName = $('titleCardName');
  const titleCardMeta = $('titleCardMeta');
  const searchInput = $('searchInput');
  const searchControls = $('searchControls');
  const searchCount = $('searchCount');
  const searchPrev = $('searchPrev');
  const searchNext = $('searchNext');
  const searchClear = $('searchClear');
  const clipName = $('clipName');
  const clipStart = $('clipStart');
  const clipEnd = $('clipEnd');
  const setStartBtn = $('setStart');
  const setEndBtn = $('setEnd');
  const addClipBtn = $('addClip');
  const clipsList = $('clipsList');
  const importClipsBtn = $('importClips');
  const exportClipsBtn = $('exportClips');
  const importSourceBtn = $('importSource');
  const sourcesList = $('sourcesList');
  const titleCardToggle = $('titleCardToggle');
  const importSourceFile = $('importSourceFile');
  const importClipsFile = $('importClipsFile');
  const loadMediaBtn = $('loadMediaBtn');
  const loadMediaFile = $('loadMediaFile');
  const mediaName = $('mediaName');

  // State
  let clips = [];
  let sources = [{ id: 'primary', name: titleData.FILE_NAME || 'Primary', lines: allLines }];
  let currentPage = 0;
  let pageEls = [];
  let lineEls = new Map();
  let activeLineIdx = -1;
  let activeClip = null;
  let viewMode = 'document';
  let showTitleCards = false;
  let searchMatches = [];
  let searchIdx = -1;
  let isFullscreen = false;
  let localMediaUrl = null;

  // Icons
  const icons = {
    play: '<polygon points="5,3 19,12 5,21"/>',
    pause: '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>',
    volHigh: '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3A4.5 4.5 0 0014 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>',
    volMute: '<path d="M16.5 12A4.5 4.5 0 0014 7.97v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51A8.796 8.796 0 0021 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06a8.99 8.99 0 003.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>',
    fsEnter: '<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>',
    fsExit: '<path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>',
    del: '<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>'
  };

  // Utils
  function fmt(sec) {
    if (!Number.isFinite(sec) || sec < 0) return '0:00';
    const s = Math.floor(sec);
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}` : `${m}:${String(ss).padStart(2,'0')}`;
  }

  function parseTime(str) {
    if (!str) return 0;
    const p = str.trim().split(':').map(Number);
    if (p.length === 3) return p[0]*3600 + p[1]*60 + p[2];
    if (p.length === 2) return p[0]*60 + p[1];
    return p[0] || 0;
  }

  // Setup video
  function updateMediaLabel(label) {
    if (!mediaName) return;
    const value = label || 'No media file selected';
    mediaName.textContent = value;
    mediaName.title = value;
  }

  function clearVideoSources() {
    while (video.firstChild) {
      video.removeChild(video.firstChild);
    }
  }

  function setVideoSources(srcList, contentType) {
    clearVideoSources();
    srcList.forEach(src => {
      const s = document.createElement('source');
      s.src = src;
      if (contentType) s.type = contentType;
      video.appendChild(s);
    });
    video.load();
  }

  function setupVideo() {
    const embeddedMedia = mediaDataEl && mediaDataEl.textContent
      ? mediaDataEl.textContent.replace(/\s+/g, '')
      : '';
    if (embeddedMedia) {
      try {
        const binary = atob(embeddedMedia);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        const blob = new Blob([bytes], { type: mediaMeta.content_type || 'video/mp4' });
        const url = URL.createObjectURL(blob);
        if (localMediaUrl) {
          URL.revokeObjectURL(localMediaUrl);
        }
        localMediaUrl = url;
        setVideoSources([url], mediaMeta.content_type);
        updateMediaLabel(titleData.FILE_NAME || mediaMeta.filename || 'Embedded media');
        return;
      } catch (err) {
        console.warn('Unable to decode embedded media, falling back to path sources.', err);
      }
    }

    if (!mediaPath) {
      updateMediaLabel('');
      return;
    }
    const paths = [mediaPath];
    const fname = mediaPath.split('/').pop().split('\\').pop();
    if (fname !== mediaPath) paths.push(fname);
    setVideoSources(paths, mediaMeta.content_type);
    updateMediaLabel(titleData.FILE_NAME || fname || mediaPath);
  }

  function loadLocalMedia(file) {
    if (!file) return;
    if (localMediaUrl) {
      URL.revokeObjectURL(localMediaUrl);
    }
    localMediaUrl = URL.createObjectURL(file);
    setVideoSources([localMediaUrl], file.type || mediaMeta.content_type);
    updateMediaLabel(file.name);
  }

  // Build pages
  function buildPages() {
    pages.innerHTML = '';
    lineEls.clear();
    pageEls = [];
    if (!allLines.length) {
      pages.innerHTML = '<div class="doc-empty">No transcript available</div>';
      return;
    }

    const pageMap = new Map();
    allLines.forEach((ln, i) => {
      const pn = ln.page_number || Math.floor(i / linesPerPage) + 1;
      if (!pageMap.has(pn)) pageMap.set(pn, []);
      pageMap.get(pn).push(i);
    });

    const pageNums = Array.from(pageMap.keys()).sort((a,b) => a-b);
    pageNums.forEach((pn, pi) => {
      const pageEl = document.createElement('div');
      pageEl.className = 'doc-page' + (pi === 0 ? ' active' : '');

      const innerEl = document.createElement('div');
      innerEl.className = 'doc-page-inner';

      pageMap.get(pn).forEach(idx => {
        const ln = allLines[idx];
        const row = document.createElement('div');
        row.className = 'doc-line';
        row.dataset.idx = idx;

        const num = document.createElement('span');
        num.className = 'line-num';
        num.textContent = ln.line_number || ((idx % linesPerPage) + 1);

        const txt = document.createElement('span');
        txt.className = 'line-text';
        const lineText = ln.rendered_text || ln.text || '';
        // Bold speaker names (format: "          SPEAKER X:   text")
        if (!ln.is_continuation && ln.speaker) {
          const speakerMatch = lineText.match(/^(\s*)([A-Z][A-Z\s]+:)(\s*)/);
          if (speakerMatch) {
            txt.innerHTML = speakerMatch[1] + '<span class="speaker-name">' + speakerMatch[2] + '</span>' + speakerMatch[3] + lineText.slice(speakerMatch[0].length).replace(/</g, '&lt;').replace(/>/g, '&gt;');
          } else {
            txt.textContent = lineText;
          }
        } else {
          txt.textContent = lineText;
        }

        row.appendChild(num);
        row.appendChild(txt);
        row.addEventListener('click', () => {
          if (typeof ln.start === 'number') {
            video.currentTime = Math.max(0, ln.start - 0.05);
            if (video.paused) video.play().catch(() => {});
          }
        });

        innerEl.appendChild(row);
        lineEls.set(idx, row);
      });

      // Page number at bottom center
      const pageNum = document.createElement('div');
      pageNum.className = 'doc-page-number';
      pageNum.textContent = String(pn);
      innerEl.appendChild(pageNum);

      pageEl.appendChild(innerEl);
      pages.appendChild(pageEl);
      pageEls.push({ el: pageEl, lineIdxs: pageMap.get(pn) });
    });

    updatePageInfo();
  }

  function showPage(idx) {
    if (idx < 0 || idx >= pageEls.length) return;
    pageEls.forEach((p, i) => p.el.classList.toggle('active', i === idx));
    currentPage = idx;
    updatePageInfo();
  }

  function updatePageInfo() {
    pageInfo.textContent = `Page ${currentPage + 1} of ${pageEls.length || 1}`;
    prevPage.disabled = currentPage <= 0;
    nextPage.disabled = currentPage >= pageEls.length - 1;
  }

  // Find active line
  function findLine(t) {
    for (let i = 0; i < allLines.length; i++) {
      const ln = allLines[i];
      if (t >= ln.start && t < ln.end) return i;
    }
    return -1;
  }

  function setActiveLine(idx) {
    if (activeLineIdx === idx) return;
    if (activeLineIdx >= 0) {
      const prev = lineEls.get(activeLineIdx);
      if (prev) prev.classList.remove('active');
    }
    activeLineIdx = idx;
    if (idx >= 0) {
      const el = lineEls.get(idx);
      if (el) {
        el.classList.add('active');
        // Find page
        for (let p = 0; p < pageEls.length; p++) {
          if (pageEls[p].lineIdxs.includes(idx)) {
            if (p !== currentPage) showPage(p);
            break;
          }
        }
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  // Captions
  function updateCaptions() {
    if (viewMode !== 'caption') return;
    const get = i => (allLines[i] && allLines[i].rendered_text) || '';
    captionPrev2.textContent = get(activeLineIdx - 2);
    captionPrev1.textContent = get(activeLineIdx - 1);
    captionCurrent.textContent = get(activeLineIdx);
    captionNext1.textContent = get(activeLineIdx + 1);
    captionNext2.textContent = get(activeLineIdx + 2);
  }

  // Time update
  function onTimeUpdate() {
    const t = video.currentTime;
    const d = video.duration || durationSec || 0;
    if (d > 0) {
      const pct = (t / d) * 100;
      progressBar.value = pct;
      progressFill.style.width = pct + '%';
      durationEl.textContent = fmt(d);
    }
    currentTimeEl.textContent = fmt(t);

    const li = findLine(t);
    if (li !== activeLineIdx) {
      setActiveLine(li);
      updateCaptions();
    }

    // Clip end check
    if (activeClip && t >= activeClip.end) {
      video.pause();
      activeClip = null;
    }
  }

  // Controls
  playBtn.addEventListener('click', () => video.paused ? video.play().catch(()=>{}) : video.pause());
  rewindBtn.addEventListener('click', () => video.currentTime = Math.max(0, video.currentTime - 10));
  forwardBtn.addEventListener('click', () => video.currentTime = Math.min(video.duration || 0, video.currentTime + 10));

  progressBar.addEventListener('input', e => {
    const d = video.duration || durationSec || 0;
    if (d) {
      video.currentTime = (Number(e.target.value) / 100) * d;
      progressFill.style.width = e.target.value + '%';
    }
  });

  volumeSlider.addEventListener('input', () => {
    video.volume = Number(volumeSlider.value);
    updateVolIcon();
  });

  muteBtn.addEventListener('click', () => {
    if (video.volume > 0) {
      volumeSlider.dataset.prev = video.volume;
      video.volume = 0;
      volumeSlider.value = 0;
    } else {
      const v = Number(volumeSlider.dataset.prev) || 1;
      video.volume = v;
      volumeSlider.value = v;
    }
    updateVolIcon();
  });

  function updateVolIcon() {
    volIcon.innerHTML = video.volume === 0 ? icons.volMute : icons.volHigh;
  }

  video.addEventListener('play', () => playIcon.innerHTML = icons.pause);
  video.addEventListener('pause', () => playIcon.innerHTML = icons.play);
  video.addEventListener('timeupdate', onTimeUpdate);
  video.addEventListener('loadedmetadata', () => {
    durationEl.textContent = fmt(video.duration);
  });

  // Fullscreen
  fullscreenBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) app.requestFullscreen().catch(()=>{});
    else document.exitFullscreen();
  });

  document.addEventListener('fullscreenchange', () => {
    isFullscreen = !!document.fullscreenElement;
    app.classList.toggle('fullscreen', isFullscreen);
    fsIcon.innerHTML = isFullscreen ? icons.fsExit : icons.fsEnter;
  });

  // Sidebar
  menuBtn.addEventListener('click', () => sidebar.classList.remove('collapsed'));
  sidebarClose.addEventListener('click', () => sidebar.classList.add('collapsed'));

  // Pages
  prevPage.addEventListener('click', () => showPage(currentPage - 1));
  nextPage.addEventListener('click', () => showPage(currentPage + 1));

  // View mode
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      viewMode = btn.dataset.view;
      const isCaptionMode = viewMode === 'caption';
      videoPane.classList.toggle('caption-mode', isCaptionMode);
      contentArea.classList.toggle('caption-mode', isCaptionMode);
      document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b === btn));
      if (isCaptionMode) updateCaptions();
    });
  });

  // Title cards toggle
  titleCardToggle.addEventListener('click', () => {
    showTitleCards = !showTitleCards;
    titleCardToggle.classList.toggle('active', showTitleCards);
  });

  // Search
  function doSearch(q) {
    lineEls.forEach(el => el.classList.remove('search-match', 'search-current'));
    searchMatches = [];
    searchIdx = -1;
    if (!q.trim()) {
      searchControls.classList.remove('visible');
      return;
    }
    const lq = q.toLowerCase();
    allLines.forEach((ln, i) => {
      const txt = (ln.rendered_text || ln.text || '').toLowerCase();
      if (txt.includes(lq)) {
        searchMatches.push(i);
        const el = lineEls.get(i);
        if (el) el.classList.add('search-match');
      }
    });
    searchControls.classList.add('visible');
    if (searchMatches.length) goSearch(0);
    else searchCount.textContent = '0/0';
  }

  function goSearch(idx) {
    if (!searchMatches.length) return;
    if (searchIdx >= 0) {
      const prev = lineEls.get(searchMatches[searchIdx]);
      if (prev) prev.classList.remove('search-current');
    }
    searchIdx = ((idx % searchMatches.length) + searchMatches.length) % searchMatches.length;
    const li = searchMatches[searchIdx];
    const el = lineEls.get(li);
    if (el) {
      el.classList.add('search-current');
      for (let p = 0; p < pageEls.length; p++) {
        if (pageEls[p].lineIdxs.includes(li)) {
          if (p !== currentPage) showPage(p);
          break;
        }
      }
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    searchCount.textContent = `${searchIdx + 1}/${searchMatches.length}`;
  }

  searchInput.addEventListener('input', () => doSearch(searchInput.value));
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); goSearch(searchIdx + (e.shiftKey ? -1 : 1)); }
    if (e.key === 'Escape') { searchInput.value = ''; doSearch(''); searchInput.blur(); }
  });
  searchPrev.addEventListener('click', () => goSearch(searchIdx - 1));
  searchNext.addEventListener('click', () => goSearch(searchIdx + 1));
  searchClear.addEventListener('click', () => { searchInput.value = ''; doSearch(''); });

  // Clips
  function buildClips() {
    if (!clips.length) {
      clipsList.innerHTML = '<div class="no-clips">No clips yet</div>';
      return;
    }
    clipsList.innerHTML = '';
    clips.forEach((c, i) => {
      const item = document.createElement('div');
      item.className = 'clip-item';
      item.innerHTML = `
        <div class="clip-item-header">
          <div>
            <div class="clip-item-name">${c.name || 'Clip ' + (i+1)}</div>
            <div class="clip-item-time">${fmt(c.start)} - ${fmt(c.end)}</div>
          </div>
          <button type="button" class="clip-item-delete" data-idx="${i}"><svg viewBox="0 0 24 24">${icons.del}</svg></button>
        </div>
      `;
      item.addEventListener('click', e => { if (!e.target.closest('.clip-item-delete')) playClip(i); });
      item.querySelector('.clip-item-delete').addEventListener('click', e => { e.stopPropagation(); deleteClip(i); });
      clipsList.appendChild(item);
    });
  }

  function playClip(idx) {
    const c = clips[idx];
    if (!c) return;
    const doPlay = () => {
      activeClip = { end: c.end };
      video.currentTime = c.start;
      video.play().catch(()=>{});
    };
    if (showTitleCards) {
      titleCardName.textContent = c.name || 'Clip';
      titleCardMeta.textContent = fmt(c.start);
      titleCard.classList.add('visible');
      setTimeout(() => { titleCard.classList.remove('visible'); setTimeout(doPlay, 500); }, 3000);
    } else {
      doPlay();
    }
  }

  function deleteClip(idx) { clips.splice(idx, 1); buildClips(); }

  setStartBtn.addEventListener('click', () => clipStart.value = fmt(video.currentTime));
  setEndBtn.addEventListener('click', () => clipEnd.value = fmt(video.currentTime));
  addClipBtn.addEventListener('click', () => {
    const s = parseTime(clipStart.value);
    const e = parseTime(clipEnd.value);
    if (e > s) {
      clips.push({ name: clipName.value || '', start: s, end: e });
      clipName.value = ''; clipStart.value = ''; clipEnd.value = '';
      buildClips();
    }
  });

  // Import/Export clips
  exportClipsBtn.addEventListener('click', () => {
    if (!clips.length) return;
    const data = JSON.stringify({ clips, exportedAt: new Date().toISOString() }, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'clips.json';
    a.click();
  });

  importClipsBtn.addEventListener('click', () => importClipsFile.click());
  importClipsFile.addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const d = JSON.parse(r.result);
        if (Array.isArray(d.clips)) { clips = d.clips; buildClips(); }
      } catch(err) { alert('Invalid clips file'); }
    };
    r.readAsText(f);
    e.target.value = '';
  });

  // Import source
  importSourceBtn.addEventListener('click', () => importSourceFile.click());
  importSourceFile.addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const html = r.result;
        const m = html.match(/<script[^>]*id="transcript-data"[^>]*>([\s\S]*?)<\/script>/);
        if (!m) throw new Error('No transcript data found');
        const json = m[1].trim();
        if (!json || json.charAt(0) !== '{') throw new Error('Template file');
        const d = JSON.parse(json);
        const name = (d.meta?.title?.FILE_NAME) || f.name;
        sources.push({ id: 'src-' + Date.now(), name, lines: d.lines || [] });
        buildSources();
      } catch(err) { alert('Could not import: ' + err.message); }
    };
    r.readAsText(f);
    e.target.value = '';
  });

  // Load local media (playback only, does not import transcripts)
  if (loadMediaBtn && loadMediaFile) {
    loadMediaBtn.addEventListener('click', () => loadMediaFile.click());
    loadMediaFile.addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      loadLocalMedia(f);
      e.target.value = '';
    });
  }

  function buildSources() {
    sourcesList.innerHTML = '';
    sources.forEach(s => {
      const item = document.createElement('div');
      item.className = 'clip-item';
      item.innerHTML = `<div class="clip-item-name">${s.name}</div><div class="clip-item-time">${s.lines.length} lines</div>`;
      sourcesList.appendChild(item);
    });
  }

  // Keyboard
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
      e.preventDefault();
      sidebar.classList.remove('collapsed');
      searchInput.focus();
      searchInput.select();
      return;
    }
    if (e.target.tagName === 'INPUT') return;
    switch(e.key) {
      case ' ': e.preventDefault(); video.paused ? video.play().catch(()=>{}) : video.pause(); break;
      case 'ArrowLeft': video.currentTime = Math.max(0, video.currentTime - 10); break;
      case 'ArrowRight': video.currentTime = Math.min(video.duration || 0, video.currentTime + 10); break;
      case 'ArrowUp': e.preventDefault(); showPage(currentPage - 1); break;
      case 'ArrowDown': e.preventDefault(); showPage(currentPage + 1); break;
      case 'f': case 'F': fullscreenBtn.click(); break;
      case 'c': case 'C': document.querySelector(`.view-btn[data-view="${viewMode === 'caption' ? 'document' : 'caption'}"]`).click(); break;
      case 'Escape': if (isFullscreen) document.exitFullscreen(); break;
    }
  });

  video.addEventListener('dblclick', () => fullscreenBtn.click());

  // Audio waveform visualizer (Web Audio API)
  const waveformCanvas = document.getElementById('waveformCanvas');
  let audioCtx = null;
  let analyser = null;
  let animFrameId = null;
  let waveformConnected = false;

  function isAudioOnly() {
    const ct = (mediaMeta.content_type || '').toLowerCase();
    return ct.startsWith('audio/') || (!ct.startsWith('video/') && !video.videoWidth);
  }

  function initWaveform() {
    if (waveformConnected || !waveformCanvas) return;
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      const source = audioCtx.createMediaElementSource(video);
      source.connect(analyser);
      analyser.connect(audioCtx.destination);
      waveformConnected = true;
    } catch(err) {
      console.warn('Waveform init failed:', err);
    }
  }

  function drawWaveform() {
    if (!analyser || !waveformCanvas) return;
    const ctx = waveformCanvas.getContext('2d');
    const rect = waveformCanvas.parentElement.getBoundingClientRect();
    waveformCanvas.width = rect.width * (window.devicePixelRatio || 1);
    waveformCanvas.height = rect.height * (window.devicePixelRatio || 1);
    ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
    const w = rect.width;
    const h = rect.height;

    const bufLen = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufLen);
    analyser.getByteFrequencyData(dataArray);

    ctx.clearRect(0, 0, w, h);

    const barCount = Math.min(bufLen, 80);
    const totalBarWidth = w * 0.85;
    const barW = totalBarWidth / barCount;
    const gap = barW * 0.3;
    const effectiveBarW = barW - gap;
    const startX = (w - totalBarWidth) / 2;
    const centerY = h / 2;

    for (let i = 0; i < barCount; i++) {
      const val = dataArray[i] / 255.0;
      const barH = Math.max(val * (h * 0.45), 2);
      const x = startX + i * barW;

      const gradient = ctx.createLinearGradient(0, centerY - barH, 0, centerY + barH);
      gradient.addColorStop(0, 'rgba(148, 163, 184, 0.9)');
      gradient.addColorStop(0.5, 'rgba(203, 213, 225, 0.95)');
      gradient.addColorStop(1, 'rgba(148, 163, 184, 0.9)');
      ctx.fillStyle = gradient;

      ctx.beginPath();
      const r = Math.min(effectiveBarW / 2, 3);
      const bx = x, by = centerY - barH, bw = effectiveBarW, bh = barH * 2;
      ctx.moveTo(bx + r, by);
      ctx.lineTo(bx + bw - r, by);
      ctx.quadraticCurveTo(bx + bw, by, bx + bw, by + r);
      ctx.lineTo(bx + bw, by + bh - r);
      ctx.quadraticCurveTo(bx + bw, by + bh, bx + bw - r, by + bh);
      ctx.lineTo(bx + r, by + bh);
      ctx.quadraticCurveTo(bx, by + bh, bx, by + bh - r);
      ctx.lineTo(bx, by + r);
      ctx.quadraticCurveTo(bx, by, bx + r, by);
      ctx.fill();
    }

    animFrameId = requestAnimationFrame(drawWaveform);
  }

  function startWaveform() {
    if (!waveformCanvas) return;
    if (!waveformConnected) initWaveform();
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    waveformCanvas.style.display = 'block';
    video.style.display = 'none';
    if (!animFrameId) drawWaveform();
  }

  function stopWaveform() {
    if (animFrameId) {
      cancelAnimationFrame(animFrameId);
      animFrameId = null;
    }
  }

  function checkAudioVisual() {
    if (isAudioOnly()) {
      if (!video.paused) startWaveform();
      else {
        if (waveformCanvas) {
          waveformCanvas.style.display = 'block';
          video.style.display = 'none';
        }
        stopWaveform();
      }
    } else {
      if (waveformCanvas) waveformCanvas.style.display = 'none';
      video.style.display = '';
      stopWaveform();
    }
  }

  video.addEventListener('play', checkAudioVisual);
  video.addEventListener('pause', checkAudioVisual);
  video.addEventListener('loadedmetadata', checkAudioVisual);

  // Init
  headerTitle.textContent = titleData.CASE_NAME || titleData.FILE_NAME || 'Transcript Viewer';
  document.title = headerTitle.textContent;
  setupVideo();
  buildPages();
  buildClips();
  buildSources();
  updateVolIcon();
})();
  </script>
</body>
</html>
